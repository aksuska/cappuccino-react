{"version":3,"sources":["../src/Objective-J.js"],"names":["objj_msgSend","objj_propGuard","objj_initialize","objj_function","objj_propertyDescriptor","objj_string","objj_invocation","objj_methodSignature","objj_throw_arg","target","selector","args","targetClass","constructor","initialized","property","resolveInstanceMethod_","resolveClassMethod_","propValue","apply","descriptor","undefined","get","doesNotRecognizeSelector_","substr","length","toLowerCase","set","forwardingTarget","forwardingTargetForSelector_","methodSignature","methodSignatureForSelector_","invocation","forwardInvocation_","returnValue","object","shift","name","nam","Array","aClass","chain","Object","getPrototypeOf","unshift","i","initialize","$$initialized","load","parts","split","pop","join","proto","getOwnPropertyDescriptor","string","setArgument_atIndex_","signatureWithObjCTypes_","padEnd","error","raise_format_arguments_"],"mappings":"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","file":"Objective-J.js","sourcesContent":["/**\n * The Objective-J \"Runtime\", as it were. Essentially just a group of utility methods. They must be functions or we run into cyclical import issues since functions are hoisted, and classes aren't.\n * We generally expect that these methods will only be called internally by the framework, so we allow run-time errors to occur by passing null/undefined values.\n **/\n\nimport CPObject from './Foundation/CPObject';\nimport CPString from './Foundation/CPString';\nimport CPMethodSignature from './Foundation/CPMethodSignature';\nimport CPInvocation from './Foundation/CPInvocation';\nimport CPException, {CPInvalidArgumentException} from './Foundation/CPException';\n\n/*\n\t* A \"decorator\" kind of function that facilitates making null-targeted methods into no-ops and handles message forwarding. Compiler rewrites all method calls to this function.\n*/\n\nexport default function objj_msgSend(target, selector, ...args) {\n\t// null target returns null\n\tif (target === null)\n\t\treturn null;\n\n\t// initialize class if needed\n\tconst targetClass = target instanceof CPObject ? target.constructor : target;\n\tif (!targetClass.initialized) {\n\t\tobjj_initialize(targetClass);\n\t}\n\n\tlet property = objj_function(selector);\n\tif (property in target || (targetClass !== target && targetClass.resolveInstanceMethod_(selector)) || (targetClass === target && targetClass.resolveClassMethod_(selector))) {\n\t\tconst propValue = target[property];\n\t\tif (typeof propValue === 'function') {\n\t\t\treturn propValue.apply(target, args);\n\t\t}\n\t\telse {\n\t\t\t// property access--check for getter\n\t\t\tconst descriptor = objj_propertyDescriptor(target, selector);\n\t\t\tif (descriptor !== undefined && descriptor.get !== undefined)\n\t\t\t\treturn descriptor.get.apply(target);\n\t\t\telse\n\t\t\t\ttarget.doesNotRecognizeSelector_(selector);\n\t\t}\n\t}\n\telse {\n\t\t// check whether is setter called by name\n\t\tproperty = selector.substr(3, selector.length - 4).toLowerCase();\n\t\tif (selector.substr(0, 3) === 'set' && property in target) {\n\t\t\tconst descriptor = objj_propertyDescriptor(target, property);\n\t\t\tif (descriptor !== undefined && descriptor.set !== undefined)\n\t\t\t\treturn descriptor.set.apply(target, args);\n\t\t}\n\t\t// otherwise see if we can forward the message\n\t\tconst forwardingTarget = target.forwardingTargetForSelector_(selector);\n\t\tif (forwardingTarget && forwardingTarget !== target) {\n\t\t\treturn objj_msgSend(forwardingTarget, selector, ...args);\n\t\t}\n\t\telse {\n\t\t\t// lastly see if we can use forwardInvocation\n\t\t\tconst methodSignature = target.methodSignatureForSelector_(selector);\n\t\t\tif (methodSignature) {\n\t\t\t\tconst invocation = objj_invocation(target, selector, ...args);\n\t\t\t\tif (invocation) {\n\t\t\t\t\ttarget.forwardInvocation_(invocation);\n\t\t\t\t\t// if the above doesn't throw, we need to return the value\n\t\t\t\t\treturn invocation.returnValue;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t\ttarget.doesNotRecognizeSelector_(selector);\n\t\t}\n\t}\n}\n\n/*\n\t* A \"decorator\" kind of function that facilitates null-targeted dot syntax property access into no-ops. Compiler wraps all objects with dot syntax property access with this call.\n\t* Will also support standard JS calls and chained calls: e.g. CPObject.alloc().init() -> objj_propGuard(CPObject, 'alloc', [], 'init', [])\n*/\n\nexport function objj_propGuard(object, ...args) {\n\twhile(args.length) {\n\t\tif (object === null)\n\t\t\treturn null;\n\n\t\tlet target = object, property = args.shift();\n\n\t\t// must exist\n\t\tif (property in target === false)\n\t\t\tobjj_throw_arg(`Property '%s' not found on %s of type '%s'`, property, typeof target === 'function' ? 'class' : 'object', typeof target === 'function' ? target.name : target.constructor.nam);\n\n\t\tobject = object[property];\n\t\tif (typeof object === 'function')\n\t\t\tobject = object.apply(target, args.shift());\n\t\telse if (args.length === 1 && args[0] instanceof Array)\n\t\t{\n\t\t\t// assume that data property with single extra value is setter\n\t\t\tobject[property] = args.shift()[0];\n\t\t}\n\t}\n\n\treturn object;\n}\n\n/*\n * +initialize support: called to run the one-time initialization of a class and its superclass. Can also be used as a wrapper to ensure initialization\n * on property access/method calls when forwarding is not needed or desired. Keeps track of what is initialized by adding classes as properties to function object.\n*/\n\nexport function objj_initialize(aClass) {\n\t// need to initialize top-down\n\tlet chain = [];\n\tfor (let targetClass = aClass; targetClass !== Object.getPrototypeOf(CPObject); targetClass = Object.getPrototypeOf(targetClass)) {\n\t\tif (!targetClass.initialized)\n\t\t\tchain.unshift(targetClass);\n\t}\n\n\tfor (let i = 0; i < chain.length; i++) {\n\t\tlet targetClass = chain[i];\n\t\ttargetClass.initialize();\n\t\ttargetClass.$$initialized = true;\n\t\ttargetClass.load();\n\t}\n\n\t// return arg so we can use as wrapper\n\treturn aClass;\n}\n\n/*\n * Converts Objective-J selector string into the javascript function name\n*/\n\nexport function objj_function(selector) {\n\t// let null be null\n\tif (selector === null)\n\t\treturn null;\n\n\tlet parts = selector.split(':');\n\tif (parts[parts.length-1].length === 0)\n\t\tparts.pop();\n\treturn parts.join('_');\n}\n\n/*\n * Utility function to get descriptor for property on object anywhere on the prototype chain\n*/\n\nexport function objj_propertyDescriptor(object, property) {\n\tif (property in object === false)\n\t\treturn undefined;\n\n\tlet proto = object, descriptor;\n\tdo {\n\t\tdescriptor = Object.getOwnPropertyDescriptor(proto, property);\n\t\tproto = Object.getPrototypeOf(proto);\n\t}\twhile(descriptor === undefined && proto !== null);\n\n\treturn descriptor;\n}\n\n/*\n * Convenience functions for creating objects that may depends on caller declaration, to avoid circular dependencies.\n*/\n\n// wrapper for string convenience constructor\nexport function objj_string(string) {\n\treturn new CPString(string);\n}\n\n// wrapper for CPInvocation creation\nexport function objj_invocation(target, selector, ...args) {\n\tconst methodSignature = objj_msgSend(target, 'methodSignatureForSelector:', selector);\n\tif (methodSignature !== null) {\n\t\tconst invocation = objj_msgSend(CPInvocation, 'invocationWithMethodSignature:', methodSignature);\n\t\tif (invocation) {\n\t\t\tinvocation.target = target;\n\t\t\tinvocation.selector = selector;\n\t\t\tfor (let i= 0; i < args.length; i++) {\n\t\t\t\tinvocation.setArgument_atIndex_(args[i], i + 2);\n\t\t\t}\n\t\t}\n\t\treturn invocation;\n\t}\n\treturn null;\n}\n\n// wrapper for method signature creation\nexport function objj_methodSignature(object, selector) {\n\tif (objj_function(selector) in object === false)\n\t\treturn null;\n\n\treturn objj_initialize(CPMethodSignature).signatureWithObjCTypes_('@@:'.padEnd(object[selector].length, '@'));\n}\n\n// wrapper for -[CPException raise:format:arguments:] for CPInvalidArgumentException\nexport function objj_throw_arg(error, ...args) {\n\tobjj_initialize(CPException).raise_format_arguments_(CPInvalidArgumentException, new CPString(error), args);\n}\n"]}